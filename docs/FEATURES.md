# 機能ドキュメント

このドキュメントでは、milistennaの各機能について詳しく説明します。

## 認証機能

### MiAuth認証

milistennaは、Misskeyの公式認証システムであるMiAuthを使用しています。

#### 認証フロー

1. **インスタンス入力**
   - ユーザーが接続したいMisskeyインスタンスのドメインを入力
   - Zodによるドメイン形式のバリデーション（正規表現でドメイン形式を検証）

2. **MiAuthサポート確認**
   - `/api/endpoints`エンドポイントで`miauth/gen-token`の存在を確認
   - 非対応の場合は「インスタンスがMiAuthに対応していないようです。」とエラーメッセージを表示
   - インスタンスに接続できない場合は「それは正しいMisskeyインスタンスですか？」と表示

3. **認証ページへのリダイレクト**
   - セッションID（UUID v4）を生成
   - 必要な権限を指定：
     - `read:account`: アカウント情報の読み取り
     - `write:account`: アカウント情報の変更
     - `read:following`: フォロー情報の読み取り
   - アプリ名「milistenna」とアイコンURLを指定してMiAuth URLに遷移

4. **トークン取得**
   - ユーザーが認証を許可
   - コールバックURL(`/login/getToken?session={sessionId}`)に戻る
   - `/api/miauth/{sessionId}/check`でトークンを取得

5. **ユーザー情報取得・セッション保存**
   - `/api/i`でログインユーザーの詳細情報を取得
   - トークン、インスタンス情報、ユーザー情報をZustandストアに保存
   - ローカルストレージに永続化
   - トップページにリダイレクト

#### セキュリティ

- トークンはローカルストレージに保存（ブラウザのセキュリティに依存）
- HTTPS接続を推奨
- トークンの有効期限はMisskey側で管理

### ログアウト

- Zustandストアから認証情報を削除
- ローカルストレージからも削除
- ルーターを無効化して再初期化

### 認証ガード

- `_auth`レイアウトルートで認証状態を確認
- 未認証の場合は`/login`にリダイレクト
- ログイン済みの場合、`/login`にアクセスすると`/`にリダイレクト

## トップページ

- リスト管理とアンテナ管理への導線を2つのカードで表示
- 「リスト一覧」ボタン → `/list`に遷移
- 「アンテナ一覧」ボタン → `/antenna`に遷移

## リスト管理機能

### リスト一覧（`/list`）

- ユーザーが作成したすべてのリストをグリッド表示
- 各リストカードに以下の操作ボタンを表示：
  - **開く**: Misskeyインスタンスのリストページを外部タブで開く
  - **編集**: リスト編集ページに遷移
  - **削除**: 確認ダイアログ後に削除
- データなしの場合は`EmptyState`コンポーネントを表示

### リスト作成

1. **FABボタンをクリック**
   - 右下に固定表示されたプラスアイコンのFABをクリック

2. **上限チェック**
   - インスタンスのポリシー(`userListLimit`)に基づくリスト数の上限を確認
   - 上限に達している場合は`LimitAlert`を表示し、作成モーダルは開かない

3. **リスト名入力（モーダル）**
   - リスト名を入力（必須）
   - バリデーション：1文字以上100文字以下

4. **作成実行**
   - `users/lists/create`エンドポイントを呼び出し
   - 成功時にリスト一覧を自動更新し、モーダルを閉じる

### リスト編集（`/list/:edit`）

#### リスト情報の変更

- リスト名の編集
- パブリック設定（Switch）の切り替え
- `users/lists/update`で更新

#### メンバー管理

1. **ユーザー検索・追加**
   - `AddUserModal`でユーザーを検索
   - ユーザー名とホスト名で検索（デバウンス処理付き、500ms）
   - 検索結果からユーザーを選択して追加
   - `users/lists/push`で追加
   - インスタンスのポリシー(`userEachUserListsLimit`)に基づくメンバー数の上限を確認
   - 上限到達時は`LimitAlert`を表示

2. **ユーザー削除**
   - リストから削除したいユーザーの削除ボタンをクリック
   - 確認モーダルを表示（`ConfirmModal`に`UserCard`を表示）
   - `users/lists/pull`で削除

### リスト削除

1. 削除ボタンをクリック
2. 確認モーダルを表示
3. `users/lists/delete`で削除
4. リスト一覧とアンテナ一覧の両方を再取得（リスト削除でアンテナも影響を受ける可能性があるため）
5. リスト一覧に戻る

## アンテナ管理機能

### アンテナ一覧（`/antenna`）

- ユーザーが作成したすべてのアンテナをグリッド表示
- 各アンテナカードに以下の情報と操作を表示：
  - アンテナ名
  - ソース種別の日本語表示
  - **開く**: Misskeyインスタンスのアンテナページを外部タブで開く
  - **編集**: アンテナ編集ページに遷移
  - **コピー**: アンテナの設定を複製して新規作成
  - **削除**: 確認ダイアログ後に削除
- データなしの場合は`EmptyState`コンポーネントを表示

### アンテナ作成（`/antenna/create`）

1. **FABボタンまたはリンクをクリック**
   - 上限未達時: `FloatLinkButton`で作成ページに直接遷移
   - 上限到達時: FABクリックで`LimitAlert`を表示

2. **作成ページでフォーム入力**
   - `$edit`パラメータが`create`のとき、空のフォームが表示される
   - アンテナ名（必須）
   - ソース選択
   - キーワード設定
   - 各種オプション

3. **作成実行**
   - `antennas/create`エンドポイントを呼び出し
   - 成功時にアンテナ一覧に戻る

### アンテナ編集（`/antenna/:edit`）

- 作成時と同様のフォームで編集
- ルートローダーで`antennas/show`からデータをプリフェッチ
- `antennas/update`で更新
- すべての設定項目を変更可能
- フォーム下部に削除ボタンも配置

### アンテナのコピー

1. アンテナ一覧でコピーボタンをクリック
2. インスタンスのポリシー(`antennaLimit`)に基づく上限を確認
3. 上限未達の場合、コピーモーダルが開く
4. デフォルト名は「{元のアンテナ名} のコピー」（変更可能）
5. 元アンテナの全設定（ソース、キーワード、各オプション）をそのまま複製
6. `antennas/create`で新規作成として実行
7. 成功後にアンテナ一覧を再取得

### アンテナ削除

1. 削除ボタンをクリック
2. 確認モーダルを表示
3. `antennas/delete`で削除
4. アンテナ一覧を再取得して一覧に戻る

## アンテナフォームの詳細

### 基本設定

| フィールド | 種類 | 説明 |
|---|---|---|
| name | Input | アンテナ名（必須） |
| src | NativeSelect | ソース種別 |
| keywords | Textarea | 含めるキーワード（スペース=AND / 改行=OR） |
| excludeKeywords | Textarea | 除外するキーワード（同上） |

### ソース種別

| 値 | 説明 | 追加フィールド |
|---|---|---|
| `all` | すべての投稿 | なし |
| `users` | 指定したユーザーの投稿 | users（Textarea: 1行1ユーザー） |
| `users_blacklist` | 指定したユーザーを除いたすべて | users（Textarea: 1行1ユーザー） |
| `list` | 指定したリスト | リスト選択（SelectListModal） |

### ソース別の追加フィールド

- **指定したユーザー / 除外ユーザー**: テキストエリアに1行1ユーザーでハンドルを入力。`AddUserToTextButton`でユーザー検索モーダルから挿入も可能
- **指定したリスト**: `SelectListModal`でリスト一覧からカード形式で選択。テキスト検索によるフィルタリング機能付き

### 詳細オプション（すべてSwitch）

| フィールド | 説明 |
|---|---|
| localOnly | ローカルのみ |
| caseSensitive | 大文字小文字を区別 |
| excludeBots | Botを除外 |
| withReplies | リプライを含む |
| withFile | ファイル付きのみ |
| excludeNotesInSensitiveChannel | センシティブチャンネルを除外 |

## 上限管理機能（LimitAlert）

インスタンスのポリシーに基づくリソース上限を管理。上限に達した場合、`LimitAlert`コンポーネントで通知します。

### 使用箇所

| 場所 | ポリシー | 説明 |
|---|---|---|
| リスト一覧のFAB | `userListLimit` | リスト数の上限 |
| リスト編集のユーザー追加 | `userEachUserListsLimit` | リストあたりのメンバー数上限 |
| アンテナ一覧のFAB | `antennaLimit` | アンテナ数の上限 |
| アンテナコピーモーダル | `antennaLimit` | アンテナ数の上限 |

## UI/UX機能

### レスポンシブデザイン
- モバイル、タブレット、デスクトップに対応
- グリッドレイアウトが画面サイズに応じて調整
- ヘッダーの余白がレスポンシブに変化

### カラーモード
- ライトモード
- ダークモード
- ヘッダーメニューから切り替え可能

### ヘッダー
- スティッキー配置（スクロールに追従）
- グラスモーフィズム効果（背景ぼかし+半透明）
- アプリ名（トップページへのリンク）
- メニュー（カラーモード切替、ログアウト、アバター表示）

### ローディング状態
- データ取得中にローディングインジケータ（`Loader`）を表示

### エラーハンドリング
- Misskey APIエラー時にエラーメッセージを表示
- ネットワークエラーの検出
- 適切なフィードバック

### 空状態
- データが存在しない場合に`EmptyState`コンポーネントを表示

### 確認ダイアログ
- 削除操作前に`ConfirmModal`で確認を表示
- 操作内容を明示して誤操作を防止

## データ管理

### キャッシング
- TanStack Queryによる自動キャッシング
- スマートな再取得戦略
- バックグラウンド更新

### 状態の永続化
- ログイン状態のローカルストレージ保存
- ページリロード後も状態を維持

## パフォーマンス

### 遅延ローディング
- ルートごとのコード分割
- 必要に応じた動的インポート

### デバウンス処理
- ユーザー検索時の無駄なAPI呼び出しを防止
- 500msのデバウンス時間

### メモ化
- React Compilerによる自動最適化
- 不要な再レンダリングの防止
